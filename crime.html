<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <title>Public Incident Reporting System - Form / Crime</title>
    <link rel="stylesheet" href="form-styles.css">
    <script type="text/javascript" src="script.js" defer></script>
</head>

<body class="">
    <div class="container">
        <nav>
            <input type="checkbox" id="sidebar-active">
            <label for="sidebar-active" class="sidebar-open">
                <i class="fa-solid fa-bars"></i>
            </label>

            <label for="sidebar-active" id="overlay"></label>
            <div class="links-container">
                <label for="sidebar-active" class="sidebar-close">
                    <i class="fa-solid fa-xmark"></i>
                </label>

                <div class="navigations">
                    <a href="index.html" class="active">Home</a>
                    <a href="about.html">About</a>
                </div>
            </div>

            <div class="options">
                <button id="theme-switch">
                    <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px" fill="#e3e3e3">
                      <path
                        d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q10 0 20.5.67 10.5.66 24.17 2-37.67 31-59.17 77.83T444-660q0 90 63 153t153 63q53 0 99.67-20.5 46.66-20.5 77.66-56.17 1.34 12.34 2 21.84.67 9.5.67 18.83 0 150-105 255T480-120Z" />
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px" fill="#e3e3e3">
                      <path
                        d="M480-280q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280ZM200-446.67H40v-66.66h160v66.66Zm720 0H760v-66.66h160v66.66ZM446.67-760v-160h66.66v160h-66.66Zm0 720v-160h66.66v160h-66.66ZM260-655.33l-100.33-97 47.66-49 96 100-43.33 46Zm493.33 496-97.66-100.34 45-45.66 99.66 97.66-47 48.34Zm-98.66-541.34 97.66-99.66 49 47L702-656l-47.33-44.67ZM159.33-207.33 259-305l46.33 45.67-97.66 99.66-48.34-47.66Z" />
                    </svg>
                  </button>

                <div class="admin-login">
                    <a href="admin-login.html">Admin Login</a>
                </div>
            </div>
        </nav>

        <main>
            <div class="top-left">
                <img src="images/fieldincident.png" alt="">
            </div>
            <div class="top-right">
                <form action="crime_reports.php" id="crimeForm" class="form" enctype="multipart/form-data">
                    <p class="text-center">Report a Crime</p>

                    <div class="progressbar">
                        <div class="progress" id="progress"></div>

                        <div class="progress-step progress-step-active"></div>
                        <div class="progress-step"></div>
                    </div>

                    <div class="form-step form-step-active">
                        <div class="card-title">
                            <h1>Crime Info</h1>
                        </div>
                        <div class="input-group">
                            <label for="crimeType">
                                Type of Crime
                                <span id="crimeTypeError" class="error-message"></span>
                            </label>
                            <select id="crimeType" name="crimeType" required>
                                <option value="">Select an option</option>
                                <option value="Theft">Theft</option>
                                <option value="Shooting">Shooting</option>
                                <option value="Drugs">Drugs</option>
                                <option value="Homicide">Homicide</option>
                                <option value="Abuse">Abuse</option>
                                <option value="Arson">Arson</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="address">
                                Location
                                <span id="addressError" class="error-message"></span>
                            </label>
                            <input type="text" name="address" id="address" placeholder="Click the location icon."
                                required />
                            <i class="fa-solid fa-location-dot" id="locationIcon" onclick="getLocation()"></i>
                        </div>

                        <p id="status"></p>
                        <div id="map"></div>

                        <div class="btns-group">
                            <a href="#" class="btn btn-prev">Previous</a>
                            <a href="#" class="btn btn-next">Next</a>
                        </div>
                    </div>

                    <div class="form-step">
                        <div class="card-title">
                            <h1>Crime Info</h1>
                        </div>
                        <div class="input-group">
                            <label for="additionalInfo">Provide additional info about the crime</label>
                            <textarea id="additionalInfo" name="additionalInfo" class="text-field"
                                placeholder="Enter your message here..."></textarea>
                            <span id="detailsError" class="error-message"></span>
                        </div>
                        <div class="btns-group">
                            <a href="#" class="btn btn-prev">Previous</a>
                            <button type="button" id="submit">Submit</button>
                        </div>
                    </div>

                </form>
            </div>
        </main>

        <footer>
            <div class="footer-top">
                <div class="navs">
                    <a href="index.html">Home</a>
                    <a href="about.html">About Us</a>
                    <a href="#">Terms of Services</a>
                    <a href="#">Privacy Policy</a>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="copyright">
                    <p>Â© LGU2: Public Safety Incident Reporting System</p>
                </div>
                <div class="links">
                    <i class="fa-brands fa-facebook-f"></i>
                    <i class="fa-brands fa-tiktok"></i>
                    <i class="fa-brands fa-twitter"></i>
                </div>
            </div>
            <div id="submitSuccessAlert" class="success-alert">Report submitted successfully!</div>
        </footer>
    </div>

    <script>
        // Form
        const prevBtns = document.querySelectorAll(".btn-prev");
        const nextBtns = document.querySelectorAll(".btn-next");
        const progress = document.getElementById("progress");
        const formSteps = document.querySelectorAll(".form-step");
        const progressSteps = document.querySelectorAll(".progress-step");

        let formStepsNum = 0;

        // Form navigation logic
        prevBtns.forEach((btn) => {
            btn.addEventListener("click", (e) => {
                e.preventDefault();

                // If it's the first step, redirect to another HTML page
                if (formStepsNum === 0) {
                    window.location.href = "form.html"; // Change to your actual form HTML file
                } else {
                    formStepsNum--; // Decrement only once
                    updateFormSteps();
                    updateProgressbar();
                }
            });
        });

        nextBtns.forEach((btn) => {
            btn.addEventListener("click", (e) => {
                e.preventDefault();
                // Validate the current step before moving forward
                if (validateFormStep(formStepsNum + 1)) {
                    formStepsNum++;
                    updateFormSteps();
                    updateProgressbar();
                }
            });
        });

        function updateFormSteps() {
            formSteps.forEach((formStep) => {
                formStep.classList.contains("form-step-active") &&
                    formStep.classList.remove("form-step-active");
            });

            formSteps[formStepsNum].classList.add("form-step-active");
        }

        function updateProgressbar() {
            progressSteps.forEach((progressStep, idx) => {
                if (idx < formStepsNum + 1) {
                    progressStep.classList.add("progress-step-active");
                } else {
                    progressStep.classList.remove("progress-step-active");
                }
            });

            const progressActive = document.querySelectorAll(".progress-step-active");

            progress.style.width =
                ((progressActive.length - 1) / (progressSteps.length - 1)) * 100 + "%";
        }

        function validateFormStep(stepNumber) {
            let valid = true;
            const errorMessages = {
                crimeType: "(Required)",
                address: "(Required)",
                additionalInfo: "(Required)",
            };

            // Clear previous error messages
            document.querySelectorAll(".error-message").forEach((el) => {
                el.textContent = "";
            });

            switch (stepNumber) {
                case 1:
                    const crimeType = document.getElementById("crimeType").value;
                    const address = document.getElementById("address").value.trim();

                    if (!crimeType) {
                        document.getElementById("crimeTypeError").textContent = errorMessages.crimeType;
                        valid = false;
                    }
                    if (!address) {
                        document.getElementById("addressError").textContent = errorMessages.address;
                        valid = false;
                    }

                    break;

                case 2:
                    const additionalInfo = document.getElementById("additionalInfo").value.trim();

                    if (!additionalInfo) {
                        document.getElementById("detailsError").textContent = errorMessages.additionalInfo;
                        valid = false;
                    }
                    break;
            }

            return valid;
        }


        document.getElementById('submit').addEventListener('click', (e) => {
            e.preventDefault();
            let allValid = true;

            // Validate each step
            for (let i = 1; i <= 2; i++) {
                if (!validateFormStep(i)) {
                    allValid = false;
                    break;
                }
            }

            if (allValid) {
                const formData = new FormData(document.getElementById('crimeForm'));

                fetch('php/crime_reports.php', {
                    method: 'POST',
                    body: formData,
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data?.status === 'success') {
                            const successAlert = document.getElementById('submitSuccessAlert');
                            successAlert.style.display = 'block';
                            setTimeout(() => {
                                successAlert.style.display = '';
                                window.location.href = "contact-details3.html";
                            }, 1500);
                        } else {
                            alert(data?.message || 'An error occurred.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred. Please try again.');
                    });

            } else {
                alert("Please fill out all required fields correctly.");
            }
        });


        // Location Logic
        function getLocation() {
            const status = document.getElementById('status');
            const map = document.getElementById('map');
            const addressInput = document.getElementById('address');

            if (!navigator.geolocation) {
                status.textContent = 'Geolocation is not supported by your browser.';
                return;
            }

            // Request the user's location
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    addressInput.value = `Lat: ${latitude}, Long: ${longitude}`;

                    // Display the map
                    map.innerHTML = `
            <iframe src="https://maps.google.com/maps?q=${latitude},${longitude}&z=15&output=embed" allowfullscreen>
            </iframe>`;
                },
                (error) => {
                    status.textContent = `Error: ${error.message}`;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0,
                }
            );
        }
    </script>
</body>

</html>