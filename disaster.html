<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <title>Public Incident Reporting System - Form / Disaster</title>
  <link rel="stylesheet" href="form-styles.css">
  <script type="text/javascript" src="script.js" defer></script>
</head>

<body>
  <div class="container">
    <nav>
      <input type="checkbox" id="sidebar-active">
      <label for="sidebar-active" class="sidebar-open">
        <i class="fa-solid fa-bars"></i>
      </label>

      <label for="sidebar-active" id="overlay"></label>
      <div class="links-container">
        <label for="sidebar-active" class="sidebar-close">
          <i class="fa-solid fa-xmark"></i>
        </label>

        <div class="navigations">
          <a href="index.html" class="active">Home</a>
          <a href="about.html">About</a>
        </div>
      </div>

      <div class="options">
        <button id="theme-switch">
          <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px" fill="#e3e3e3">
            <path
              d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q10 0 20.5.67 10.5.66 24.17 2-37.67 31-59.17 77.83T444-660q0 90 63 153t153 63q53 0 99.67-20.5 46.66-20.5 77.66-56.17 1.34 12.34 2 21.84.67 9.5.67 18.83 0 150-105 255T480-120Z" />
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px" fill="#e3e3e3">
            <path
              d="M480-280q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280ZM200-446.67H40v-66.66h160v66.66Zm720 0H760v-66.66h160v66.66ZM446.67-760v-160h66.66v160h-66.66Zm0 720v-160h66.66v160h-66.66ZM260-655.33l-100.33-97 47.66-49 96 100-43.33 46Zm493.33 496-97.66-100.34 45-45.66 99.66 97.66-47 48.34Zm-98.66-541.34 97.66-99.66 49 47L702-656l-47.33-44.67ZM159.33-207.33 259-305l46.33 45.67-97.66 99.66-48.34-47.66Z" />
          </svg>
        </button>

        <div class="admin-login">
          <a href="admin-login.html">Admin Login</a>
        </div>
      </div>
    </nav>

    <main>
      <div class="top-left">
        <img src="images/fieldincident.png" alt="">
      </div>
      <div class="top-right">
        <form action="disaster_reports.php" id="disasterForm" class="form" enctype="multipart/form-data">
          <h1 class="text-center">Report a Disaster</h1>

          <div class="progressbar">
            <div class="progress" id="progress"></div>
            <div class="progress-step progress-step-active"></div>
            <div class="progress-step"></div>
          </div>

          <div class="form-step form-step-active">

            <div class="card-title">
              <h1>Disaster Info</h1>
            </div>

            <div class="input-group">
              <label for="">
                Type of disaster
                <span class="error-message" id="disasterTypeError"></span>
              </label>
              <select name="disasterType" id="disasterType" required>
                <option value="">Select from the options</option>
                <option value="Typhoon">Typhoon</option>
                <option value="Earthquake">Earthquake</option>
                <option value="Hurricane">Hurricane</option>
                <option value="Fire">Fire</option>
                <option value="Flood">Flood</option>
                <option value="Others">Others</option>
              </select>
            </div>

            <div class="input-group">
              <label for="address">
                Your current address
                <span id="addressError" class="error-message"></span>
              </label>
              <input type="text" name="address" id="address" placeholder="Click the location icon." required />
              <i class="fa-solid fa-location-dot" id="locationIcon" onclick="getLocation()"></i>
            </div>

            <p id="status"></p>
            <div id="map"></div>

            <div class="btns-group">
              <a href="#" class="btn btn-prev">Previous</a>
              <a href="#" class="btn btn-next" id="nextStep2">Next</a>
            </div>
          </div>

          <div class="form-step">
            <div class="card-title">
              <h1>Disaster Info</h1>
            </div>
            <div class="input-group">
              <label for="details">Provide further details about the disaster</label>
              <textarea class="text-field" name="details" id="details" placeholder="Enter your message here..."
                required></textarea>
              <span class="error-message" id="detailsError"></span>
            </div>
            <div class="btns-group">
              <a href="#" class="btn btn-prev">Previous</a>
              <button type="button" id="submit">Submit</button>
            </div>
          </div>

        </form>
      </div>
    </main>

    <footer>
      <div class="footer-top">
        <div class="navs">
          <a href="index.html">Home</a>
          <a href="about.html">About Us</a>
          <a href="#">Terms of Services</a>
          <a href="#">Privacy Policy</a>
        </div>
      </div>
      <div class="footer-bottom">
        <div class="copyright">
          <p>Â© LGU2: Public Safety Incident Reporting System</p>
        </div>
        <div class="links">
          <i class="fa-brands fa-facebook-f"></i>
          <i class="fa-brands fa-tiktok"></i>
          <i class="fa-brands fa-twitter"></i>
        </div>
      </div>
      <div id="submitSuccessAlert" class="success-alert">Report submitted successfully!</div>
    </footer>

  </div>

  <script>
    // Form
    const prevBtns = document.querySelectorAll(".btn-prev");
    const nextBtns = document.querySelectorAll(".btn-next");
    const progress = document.getElementById("progress");
    const formSteps = document.querySelectorAll(".form-step");
    const progressSteps = document.querySelectorAll(".progress-step");

    let formStepsNum = 0;

    // Form navigation logic
    prevBtns.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();

        // If it's the first step, redirect to another HTML page
        if (formStepsNum === 0) {
          window.location.href = "form.html"; // Change to your actual form HTML file
        } else {
          formStepsNum--; // Decrement only once
          updateFormSteps();
          updateProgressbar();
        }
      });
    });

    nextBtns.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        // Validate the current step before moving forward
        if (validateFormStep(formStepsNum + 1)) {
          formStepsNum++;
          updateFormSteps();
          updateProgressbar();
        }
      });
    });

    function updateFormSteps() {
      formSteps.forEach((formStep) => {
        formStep.classList.contains("form-step-active") &&
          formStep.classList.remove("form-step-active");
      });

      formSteps[formStepsNum].classList.add("form-step-active");
    }

    function updateProgressbar() {
      progressSteps.forEach((progressStep, idx) => {
        if (idx < formStepsNum + 1) {
          progressStep.classList.add("progress-step-active");
        } else {
          progressStep.classList.remove("progress-step-active");
        }
      });

      const progressActive = document.querySelectorAll(".progress-step-active");

      progress.style.width =
        ((progressActive.length - 1) / (progressSteps.length - 1)) * 100 + "%";
    }

    function validateFormStep(stepNumber) {
      let valid = true;
      const errorMessages = {
        disasterType: "(Required)",
        address: "(Required)",
        details: "(Required)",
      };

      // Clear previous error messages
      document.querySelectorAll('.error-message').forEach((el) => {
        el.textContent = "";
      });

      switch (stepNumber) {

        case 1:
          const disasterType = document.getElementById('disasterType').value;
          const address = document.getElementById('address').value.trim();

          if (!disasterType) {
            document.getElementById('disasterTypeError').textContent = errorMessages.disasterType;
            valid = false;
          }
          if (!address) {
            document.getElementById('addressError').textContent = errorMessages.address;
            valid = false;
          }

          break;

        case 2:
          const details = document.getElementById('details').value.trim();
          if (!details) {
            document.getElementById('detailsError').textContent = errorMessages.details;
            valid = false;
          }
          break;
      }

      return valid;
    }

    document.getElementById('submit').addEventListener('click', (e) => {
      e.preventDefault();
      let allValid = true;

      // Validate each step
      for (let i = 1; i <= 2; i++) {
        if (!validateFormStep(i)) {
          allValid = false;
          break;
        }
      }

      if (allValid) {
        const formData = new FormData(document.getElementById('disasterForm'));

        fetch('php/disaster_reports.php', {
          method: 'POST',
          body: formData,
        })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              // Show success message
              const successAlert = document.getElementById('submitSuccessAlert');
              successAlert.style.display = 'block';

              setTimeout(() => {
                successAlert.style.display = '';
                window.location.href = data.redirect; // Redirect or perform any other action
              }, 1500);
            } else {
              alert(data.message); // Show error message
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
          });
      } else {
        alert("Please fill out all required fields correctly.");
      }
    });


    // Location Logic
    function getLocation() {
      const status = document.getElementById('status');
      const map = document.getElementById('map');
      const addressInput = document.getElementById('address');

      if (!navigator.geolocation) {
        status.textContent = 'Geolocation is not supported by your browser.';
        return;
      }

      // Request the user's location
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          addressInput.value = `Lat: ${latitude}, Long: ${longitude}`;

          // Display the map
          map.innerHTML = `
            <iframe src="https://maps.google.com/maps?q=${latitude},${longitude}&z=15&output=embed" allowfullscreen>
            </iframe>`;
        },
        (error) => {
          status.textContent = `Error: ${error.message}`;
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0,
        }
      );
    }
  </script>

</body>

</html>